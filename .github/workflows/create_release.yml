name: Publish Git Release

on:
  workflow_dispatch:
    inputs:
      ref:
        description: "Git ref to tag (branch, tag, or SHA)"
        required: false
        default: "master"

permissions:
  contents: write

jobs:
  create-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ inputs.ref }}

      - name: Configure Git
        run: |
          git config --global user.name 'GitHub Actions'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

      - name: Generate calendar version tag
        id: calver
        run: |
          DATE=$(date -u +'%Y-%m-%d')
          COMMIT_SHORT_HASH=$(git rev-parse --short HEAD)
          TAG="${DATE}-${COMMIT_SHORT_HASH}"

          if git rev-parse -q --verify "refs/tags/${TAG}" >/dev/null; then
            echo "Tag ${TAG} already exists."
            exit 1
          fi

          echo "tag_name=${TAG}" >> "$GITHUB_OUTPUT"

      - name: Create and push tag
        run: |
          git tag -a "${{ steps.calver.outputs.tag_name }}" -m "Release ${{ steps.calver.outputs.tag_name }}"
          git push origin "${{ steps.calver.outputs.tag_name }}"

      - name: Generate release notes
        id: release_notes
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          python - <<'PY'
          import json
          import os
          import secrets
          import urllib.request

          repo = os.environ["GITHUB_REPOSITORY"]
          token = os.environ["GITHUB_TOKEN"]
          tag = "${{ steps.calver.outputs.tag_name }}"

          url = f"https://api.github.com/repos/{repo}/releases/generate-notes"
          payload = json.dumps({"tag_name": tag}).encode()
          req = urllib.request.Request(
              url,
              data=payload,
              headers={
                  "Authorization": f"Bearer {token}",
                  "Accept": "application/vnd.github+json",
                  "X-GitHub-Api-Version": "2022-11-28",
              },
              method="POST",
          )
          with urllib.request.urlopen(req) as resp:
              data = json.load(resp)

          name = data.get("name") or f"Release {tag}"
          body = data.get("body") or ""

          delimiter = "RELEASE_BODY"
          if delimiter in body:
              delimiter = f"RELEASE_BODY_{secrets.token_hex(8)}"

          with open(os.environ["GITHUB_OUTPUT"], "a") as output:
              output.write(f"name={name}\n")
              output.write(f"body<<{delimiter}\n{body}\n{delimiter}\n")
          PY

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.calver.outputs.tag_name }}
          name: ${{ steps.release_notes.outputs.name }}
          body: ${{ steps.release_notes.outputs.body }}
